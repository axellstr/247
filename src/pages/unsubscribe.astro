---
import { createClient } from '@supabase/supabase-js';
import '../styles/global.css';

const token = Astro.url.searchParams.get('token');
let status: 'form' | 'success' | 'error' | 'invalid' = 'form';
let message = '';

// If token provided, process unsubscribe
if (token) {
  const supabaseUrl = import.meta.env.SUPABASE_URL;
  const supabaseKey = import.meta.env.SUPABASE_ANON_KEY;

  if (supabaseUrl && supabaseKey) {
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    const { data, error } = await supabase
      .from('subscribers')
      .update({ subscribed: false })
      .eq('unsubscribe_token', token)
      .select()
      .single();

    if (error || !data) {
      status = 'invalid';
      message = 'Invalid or expired unsubscribe link.';
    } else {
      status = 'success';
      message = 'You have been successfully unsubscribed.';
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unsubscribe ‚Äî Daily Stoic</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=DM+Sans:wght@400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <!-- Atmospheric Background -->
    <div class="page-background"></div>
    
    <main class="unsubscribe">
      <div class="unsubscribe__card">
        {status === 'form' && (
          <>
            <div class="unsubscribe__icon">üçÇ</div>
            <h1 class="unsubscribe__title">Until We Meet Again</h1>
            <p class="unsubscribe__text">
              We're sorry to see you go. Enter your email below to unsubscribe from daily wisdom.
            </p>
            <form id="unsubscribe-form" class="unsubscribe__form">
              <input 
                type="email" 
                name="email"
                class="subscribe-form__input" 
                placeholder="Enter your email" 
                required 
              />
              <button type="submit" class="subscribe-form__button subscribe-form__button--muted">
                <span>Unsubscribe</span>
              </button>
            </form>
            <div id="message" class="message" style="display: none;"></div>
          </>
        )}

        {status === 'success' && (
          <>
            <div class="unsubscribe__icon unsubscribe__icon--success">‚úì</div>
            <h1 class="unsubscribe__title">Farewell, Friend</h1>
            <p class="unsubscribe__text">
              {message}
            </p>
            <p class="unsubscribe__text unsubscribe__text--small">
              Remember: "The obstacle is the way."
            </p>
            <a href="/" class="unsubscribe__link">Return to Daily Stoic</a>
          </>
        )}

        {status === 'invalid' && (
          <>
            <div class="unsubscribe__icon unsubscribe__icon--error">‚úï</div>
            <h1 class="unsubscribe__title">Invalid Link</h1>
            <p class="unsubscribe__text">
              {message}
            </p>
            <a href="/" class="unsubscribe__link">Return to homepage</a>
          </>
        )}
      </div>
    </main>

    <style>
      .unsubscribe__card {
        padding: 3rem 2.5rem;
        text-align: center;
        animation: fadeInUp 0.8s var(--ease-out-expo);
      }

      .unsubscribe__icon {
        font-size: 3rem;
        margin-bottom: 1.5rem;
      }

      .unsubscribe__icon--success {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 64px;
        height: 64px;
        background: rgba(90, 154, 106, 0.15);
        border: 1px solid rgba(90, 154, 106, 0.3);
        border-radius: 50%;
        color: #8bc99a;
        font-size: 1.5rem;
      }

      .unsubscribe__icon--error {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 64px;
        height: 64px;
        background: rgba(196, 92, 92, 0.15);
        border: 1px solid rgba(196, 92, 92, 0.3);
        border-radius: 50%;
        color: #e09090;
        font-size: 1.5rem;
      }

      .unsubscribe__title {
        font-family: var(--font-display);
        font-size: 1.8rem;
        margin-bottom: 1rem;
        color: var(--color-text);
      }

      .unsubscribe__text {
        color: var(--color-text-muted);
        margin-bottom: 1.5rem;
        line-height: 1.6;
      }

      .unsubscribe__text--small {
        font-family: var(--font-serif);
        font-style: italic;
        font-size: 0.95rem;
        color: var(--color-text-secondary);
        opacity: 0.8;
      }

      .unsubscribe__form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .unsubscribe__form .subscribe-form__input {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
      }

      .subscribe-form__button--muted {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
      }

      .subscribe-form__button--muted:hover {
        background: var(--color-border);
        border-color: var(--color-border-light);
      }

      .subscribe-form__button--muted::before {
        display: none;
      }

      .unsubscribe__link {
        display: inline-block;
        margin-top: 0.5rem;
        font-size: 0.95rem;
        color: var(--color-accent);
        transition: color 0.3s ease;
      }

      .unsubscribe__link:hover {
        color: var(--color-accent-light);
      }
    </style>

    <script>
      const form = document.getElementById('unsubscribe-form') as HTMLFormElement | null;
      const messageEl = document.getElementById('message') as HTMLDivElement | null;

      if (form && messageEl) {
        const button = form.querySelector('button') as HTMLButtonElement;
        const buttonText = button.querySelector('span') as HTMLSpanElement;
        const originalText = buttonText.textContent;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const email = (form.querySelector('input[name="email"]') as HTMLInputElement).value;
          
          button.disabled = true;
          buttonText.innerHTML = '<span class="spinner"></span>Processing...';

          try {
            const response = await fetch('/api/unsubscribe', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email }),
            });

            const data = await response.json();

            if (response.ok) {
              messageEl.className = 'message message--success';
              messageEl.textContent = data.message;
            } else {
              messageEl.className = 'message message--error';
              messageEl.textContent = data.error;
            }
          } catch (error) {
            messageEl.className = 'message message--error';
            messageEl.textContent = 'Network error. Please try again.';
          } finally {
            button.disabled = false;
            buttonText.textContent = originalText;
            messageEl.style.display = 'block';
          }
        });
      }
    </script>
  </body>
</html>
